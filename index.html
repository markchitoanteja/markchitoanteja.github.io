<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Kuya Mark Wi-Fi Payment Ledger</title>

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-light">

    <div class="container mt-5">
        <div class="card shadow">
            <div class="card-body">

                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Internet Client Payment Ledger</h4>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="openDbBtn">Open Database</button>
                        <button class="btn btn-outline-success" id="exportBtn" disabled>Export</button>
                    </div>
                </div>

                <!-- Month Selection -->
                <div class="mb-3 d-flex gap-2">
                    <label class="form-label mb-0">Select Month:</label>
                    <select class="form-select" id="monthSelect" style="width:auto;" disabled></select>
                    <button class="btn btn-outline-secondary" id="addMonthBtn" disabled>Add New Month</button>
                </div>

                <!-- Add Client -->
                <button class="btn btn-primary mb-3" id="addBtn" disabled>Add Client</button>

                <!-- Table -->
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Client</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th style="width:220px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="5" class="text-center text-muted">No database loaded</td>
                        </tr>
                    </tbody>
                </table>

                <div class="fw-bold mt-2">
                    Paid: ₱<span id="paidTotal">0</span> |
                    Partially Paid: ₱<span id="partialTotal">0</span> |
                    Unpaid: ₱<span id="unpaidTotal">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="recordModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Client Payment</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="recordIndex">
                    <div class="mb-3">
                        <label class="form-label">Client Name</label>
                        <input class="form-control" id="name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (₱)</label>
                        <input type="number" class="form-control" id="amount">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input class="form-control" id="dueDate" placeholder="e.g. December 5">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Status</label>
                        <select class="form-select" id="status">
                            <option value="Fully Paid">Fully Paid</option>
                            <option value="Partially Paid">Partially Paid</option>
                            <option value="Unpaid">Unpaid</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let fileHandle = null;
        let db = { months: {} };
        let selectedMonth = null;
        const modal = new bootstrap.Modal("#recordModal");

        /* ---------- DATABASE ---------- */

        // Open database
        $("#openDbBtn").on("click", async () => {
            try {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [{ accept: { "application/json": [".json"] } }]
                });
                const file = await fileHandle.getFile();
                db = JSON.parse(await file.text());
                if (!db.months) db.months = {};
                populateMonths();
                Swal.fire("Database Loaded", "You can now manage records.", "success");
            } catch {
                Swal.fire("Cancelled", "No database selected.", "info");
            }
        });

        // Save database
        async function saveDatabase() {
            if (!fileHandle) return;
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(db, null, 2));
            await writable.close();
        }

        /* ---------- MONTH MANAGEMENT ---------- */

        function populateMonths() {
            const monthSelect = $("#monthSelect");
            monthSelect.empty();

            const monthKeys = Object.keys(db.months);
            monthKeys.forEach(m => monthSelect.append(`<option value="${m}">${m}</option>`));

            if (monthKeys.length) {
                selectedMonth = monthKeys[0];
                monthSelect.val(selectedMonth);
                renderTable();
            } else {
                selectedMonth = null;
                $("#tableBody").html('<tr><td colspan="5" class="text-center text-muted">No records</td></tr>');
            }

            $("#monthSelect, #addMonthBtn, #addBtn, #exportBtn").prop("disabled", false);
        }

        // Add new month
        $("#addMonthBtn").on("click", async () => {
            const { value: monthName } = await Swal.fire({
                title: 'New Month',
                input: 'text',
                inputLabel: 'Enter Month-Year (e.g., December-2025)',
                showCancelButton: true,
                inputValidator: value => !value ? 'Month name required' : null
            });

            if (!monthName) return;
            if (!db.months[monthName]) db.months[monthName] = [];
            selectedMonth = monthName;
            populateMonths();
            $("#monthSelect").val(selectedMonth);
            renderTable();
            await saveDatabase();
        });

        /* ---------- EXPORT ---------- */

        $("#exportBtn").on("click", () => {
            const safeFilename = `internet-payments.json`;
            const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = safeFilename;
            a.click();
            URL.revokeObjectURL(a.href);
            Swal.fire("Exported", `Saved as ${safeFilename}`, "success");
        });

        /* ---------- TABLE / UI ---------- */

        function renderTable() {
            const tbody = $("#tableBody").empty();
            if (!selectedMonth || !db.months[selectedMonth]?.length) {
                tbody.append('<tr><td colspan="5" class="text-center text-muted">No records</td></tr>');
                updateTotals();
                return;
            }

            let fully = 0, partial = 0, unpaid = 0;
            db.months[selectedMonth].forEach((c, i) => {
                if (c.status === "Fully Paid") fully += c.amount;
                else if (c.status === "Partially Paid") partial += c.amount;
                else unpaid += c.amount;

                tbody.append(`
      <tr>
        <td>${c.name}</td>
        <td>₱${c.amount}</td>
        <td>${c.dueDate}</td>
        <td class="${c.status === 'Fully Paid' ? 'text-success' : c.status === 'Partially Paid' ? 'text-warning' : 'text-danger'} fw-bold">${c.status}</td>
        <td>
          <button class="btn btn-sm btn-info receiptBtn" data-i="${i}">Receipt</button>
          <button class="btn btn-sm btn-warning editBtn" data-i="${i}">Edit</button>
          <button class="btn btn-sm btn-danger deleteBtn" data-i="${i}">Delete</button>
        </td>
      </tr>
    `);
            });
            $("#paidTotal").text(fully);
            $("#partialTotal").text(partial);
            $("#unpaidTotal").text(unpaid);
        }

        function updateTotals() {
            $("#paidTotal").text(0);
            $("#partialTotal").text(0);
            $("#unpaidTotal").text(0);
        }

        /* ---------- CRUD ---------- */

        $("#addBtn").on("click", () => {
            $("#recordIndex").val("");
            $("#name, #amount, #dueDate").val("");
            $("#status").val("Fully Paid");
            modal.show();
        });

        $("#saveBtn").on("click", async () => {
            if (!selectedMonth) return Swal.fire("Error", "No month selected", "error");

            const record = {
                name: $("#name").val().trim(),
                amount: Number($("#amount").val()),
                dueDate: $("#dueDate").val().trim(),
                status: $("#status").val()
            };
            if (!record.name || !record.amount || !record.dueDate)
                return Swal.fire("Invalid Input", "All fields are required", "error");

            const idx = $("#recordIndex").val();
            if (idx === "") db.months[selectedMonth].push(record);
            else db.months[selectedMonth][idx] = record;

            await saveDatabase();
            renderTable();
            modal.hide();
            Swal.fire("Saved", "Record updated successfully", "success");
        });

        $("#tableBody").on("click", ".editBtn", function () {
            const idx = $(this).data("i");
            const c = db.months[selectedMonth][idx];
            $("#recordIndex").val(idx);
            $("#name").val(c.name);
            $("#amount").val(c.amount);
            $("#dueDate").val(c.dueDate);
            $("#status").val(c.status);
            modal.show();
        });

        $("#tableBody").on("click", ".deleteBtn", async function () {
            const idx = $(this).data("i");
            const res = await Swal.fire({
                title: "Delete Record?",
                text: "This action cannot be undone.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Delete"
            });
            if (!res.isConfirmed) return;
            db.months[selectedMonth].splice(idx, 1);
            await saveDatabase();
            renderTable();
            Swal.fire("Deleted", "Record removed.", "success");
        });

        /* ---------- MONTH CHANGE ---------- */

        $("#monthSelect").on("change", function () {
            selectedMonth = $(this).val();
            renderTable();
        });

        /* ---------- RECEIPT GENERATION ---------- */
        $("#tableBody").on("click", ".receiptBtn", function () {
            const idx = $(this).data("i");
            const client = db.months[selectedMonth][idx];

            const url = `receipt.html?month=${encodeURIComponent(selectedMonth)}&name=${encodeURIComponent(client.name)}&amount=${encodeURIComponent(client.amount)}.00&dueDate=${encodeURIComponent(client.dueDate)}&status=${encodeURIComponent(client.status)}`;
            window.open(url, '_blank');
        });
    </script>
</body>

</html>