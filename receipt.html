<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Payment Receipt</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f0f2f5;
            font-family: "Segoe UI", Arial, sans-serif;
            padding: 40px 0;
        }

        .page-wrapper {
            display: flex;
            justify-content: center;
        }

        .receipt {
            width: 680px;
            background: #ffffff;
            padding: 40px;
            border: 1px solid #dee2e6;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .company {
            display: flex;
            align-items: center;
        }

        .company img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-right: 15px;
        }

        .company h1 {
            font-size: 1.6rem;
            margin: 0;
            font-weight: 700;
            color: #0d6efd;
        }

        .company p {
            margin: 0;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .meta {
            text-align: right;
            font-size: 0.85rem;
            color: #343a40;
        }

        hr {
            margin: 20px 0;
        }

        table {
            width: 100%;
            font-size: 0.95rem;
        }

        td {
            padding: 8px 4px;
        }

        td.label {
            font-weight: 600;
            width: 45%;
        }

        .status {
            padding: 4px 14px;
            border-radius: 14px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .paid {
            background: #198754;
            color: #ffffff;
        }

        .partial {
            background: #ffc107;
            color: #212529;
        }

        .unpaid {
            background: #dc3545;
            color: #ffffff;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .actions {
            margin-top: 25px;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="page-wrapper">
        <div id="receipt" class="receipt">

            <!-- Header -->
            <div class="header">
                <div class="company">
                    <img src="logo.png" alt="Company Logo" style="border-radius: 50%;">
                    <div>
                        <h1>Kuya Mark Wi-Fi</h1>
                        <p>Affordable ● Reliable ● Fast</p>
                    </div>
                </div>

                <div class="meta">
                    <div><strong>Receipt No:</strong> <span id="receiptNo"></span></div>
                    <div><strong>Issued:</strong> <span id="issuedDateTime"></span></div>
                </div>
            </div>

            <hr>

            <!-- Details -->
            <table>
                <tr>
                    <td class="label">Billing Month</td>
                    <td id="billingMonth"></td>
                </tr>
                <tr>
                    <td class="label">Client Name</td>
                    <td id="clientName"></td>
                </tr>
                <tr>
                    <td class="label">Amount</td>
                    <td>₱<span id="amount"></span></td>
                </tr>
                <tr>
                    <td class="label">Due Date</td>
                    <td id="dueDate"></td>
                </tr>
                <tr>
                    <td class="label">Payment Status</td>
                    <td><span id="status" class="status"></span></td>
                </tr>
            </table>

            <hr>

            <!-- Footer -->
            <div class="footer">
                This receipt confirms that payment has been recorded in our system.<br>
                Please retain this document for reference purposes.
            </div>

        </div>
    </div>

    <!-- Actions -->
    <div class="actions">
        <button class="btn btn-primary" onclick="downloadReceipt()">
            Download Receipt (PNG)
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        const params = new URLSearchParams(window.location.search);

        document.getElementById('billingMonth').textContent = params.get('month') || '';
        document.getElementById('clientName').textContent = params.get('name') || '';
        document.getElementById('amount').textContent = params.get('amount') || '';
        document.getElementById('dueDate').textContent = params.get('dueDate') || '';

        const statusEl = document.getElementById('status');
        const status = params.get('status') || '';
        statusEl.textContent = status;

        if (status === 'Fully Paid') statusEl.classList.add('paid');
        else if (status === 'Partially Paid') statusEl.classList.add('partial');
        else statusEl.classList.add('unpaid');

        /* ---------- RECEIPT NUMBER FROM DATABASE ---------- */
        document.getElementById('receiptNo').textContent =
            params.get('receiptNumber') || 'N/A';

        /* ---------- ISSUED DATE & TIME ---------- */
        const now = new Date();
        document.getElementById('issuedDateTime').textContent =
            now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

        function downloadReceipt() {
            html2canvas(document.getElementById('receipt'), {
                backgroundColor: '#ffffff',
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');

                // Format current date and time as YYYYMMDD-HHMMSS
                const now = new Date();
                const pad = num => String(num).padStart(2, '0');
                const dateTimeStr = now.getFullYear().toString() +
                    pad(now.getMonth() + 1) +
                    pad(now.getDate()) + '-' +
                    pad(now.getHours()) +
                    pad(now.getMinutes()) +
                    pad(now.getSeconds());

                // Get client name and sanitize it (remove spaces / special chars)
                const clientName = (params.get('name') || 'client')
                    .replace(/\s+/g, '_')
                    .replace(/[^a-zA-Z0-9_-]/g, '');

                // Build the filename
                const filename = `${clientName}_${dateTimeStr}.png`;

                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>

</body>

</html>